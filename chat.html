<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
	</head>

	<body>
		<!--顶部搜索框-->
		<header class="mui-bar mui-bar-nav">
            <div class="mui-bar mui-bar-standard">
                <div class="mui-input-row mui-search">
             		<input id="search" type="search" class="mui-input-clear" placeholder="搜索 医生/朋友">
                </div>
            </div>
        </header>
        
        <!--弹出菜单 (默认隐藏)-->
		<div id="popover" class="mui-popover">
		</div>
		
		<!--好友列表-->
		<div class="mui-content mui-scroll-wrapper" id="home">
	        <div class="mui-scroll">
				<div class="mui-card">
					<div class="mui-card-header mui-card-media" style="height: 70px;">
						<img src="./images/logo.png" style="height: 100%;width: auto;"/>
						<div class="mui-media-body" style="padding: 8px 15px;">
							<span style="font-size: 20px;">杨英明</span>
							<p>发表于 2016-06-30 15:30</p>
						</div>
					</div>
				</div>
	        </div>
		</div>
		
		<!--HTML模板（弹出菜单）-->
		<script id="search-template" type="text/html">
			{{ each items item }}
			<div class="mui-card-header mui-card-media" id="{{item._id}}">
				<img src="./images/logo.png"/>
				<div class="mui-media-body">
					<span>{{item.name}}（{{item.nickname}}）</span>
					<p>{{item.introduction}}</p>
				</div>
			</div>
	    	{{ /each }}
    	</script>
		
		<script src="js/mui.min.js"></script>
		<script src="js/template-web.js"></script>
		<script src="js/app.js"></script>
		<script type="text/javascript">
			mui.init();
			
			mui.plusReady(function(){
			    //预加载 im 页
			    mui.preload({
			        url: 'im.html',
			        id: 'im.html',
			        styles: {
			            "render": "always",//一直渲染
			            "popGesture": "hide"
			        }
			    });
			    
		     	// 监听滑动事件
		     	var changeTab = function(curTab, targetTab, targetTabTitle){
		      		var curWebview = plus.webview.currentWebview();		     		
		      		var targetWebview = plus.webview.getWebviewById(targetTab);
		      		targetWebview.show();
		      		curWebview.hide();
					// 获取当前页面的父页面（创建它的页面）
					var index = plus.webview.getLaunchWebview();
//					var index = curWebview.opener();
		      		// 在父页面执行JS，激活父页面中对应选择卡，修改标题
					index.evalJS("document.getElementById('chat.html').classList.remove('mui-active');document.getElementById('" + targetTab + "').classList.add('mui-active');document.getElementById('title').innerHTML='" + targetTabTitle + "';");
		     	};
		      	document.querySelector('body').addEventListener('swipeleft',function(e){
		      		changeTab('chat.html','setting.html','设置');
		      	});
		      	document.querySelector('body').addEventListener('swiperight',function(e){
		      		changeTab('chat.html','home.html','首页');
		      	});
		      	
		      	// 监听搜索框输入事件
		      	var searchInput = document.getElementById('search');
		      	searchInput.addEventListener('input', function(e){
		      		// 获取搜索框内容
		      		var name = searchInput.value;
		      		// 输入空串不做处理
		      		if (name.replace(/^\s\s*/, '').replace(/\s\s*$/, '') === ''){
		      			mui('#popover').popover('hide');
		      			return ;
		      		}
		      		// 先隐藏之前的弹出菜单
		      		mui('#popover').popover('hide');
		      		// 模糊匹配指定用户名
					mui.getJSON('http://ihealth.yangyingming.com/api/v1/userlist?name=' + name + '&limit=10',function(data){
						var searchResult = document.getElementById('popover');
						// 根据模板将数据渲染成 HTML
						var html = template('search-template', {'items':data});
						if (html.replace(/^\s\s*/, '').replace(/\s\s*$/, '') === ''){
							html = '<div style="text-align:center;margin:10px;font-size:14px;">没有找到这个人耶  >_<|||</div>'; 
						}
						// 将HTML插入到弹出菜单中
						searchResult.innerHTML = html;
						// 显示弹出菜单
		      			mui('#popover').popover('toggle',document.getElementsByTagName('header')[0]);
//		      			mui('#popover').popover('show');
					});
		      	});
		      	
		      	// 监听搜索框点击事件
			    document.querySelector('body').addEventListener('tap',function (e) {
			    	// 点击每个 card 上的 标题、图片、文字简介 时，捕获事件
			    	// 获取选中用户的 id
			    	var id = null;
				    if ( e.target.parentNode.classList.contains('mui-card-header') ){
				    	id = e.target.parentNode.getAttribute('id');
				    }
				    else if( e.target.parentNode.className == 'mui-media-body' ){
				    	id = e.target.parentNode.parentNode.getAttribute('id');
				    }
				    else{
				    	// 没有捕获到事件，直接退出
				    	return ;
				    }
				    // 响应捕获事件，打开聊天页面
				    // 将聊天对象id存入本地
				    var settings = app.getSettings();
				    settings.imTargetID = id;
				    app.setSettings(settings);
					// 打开聊天页面 
					mui.openWindow({
						url:'im.html',
						id:'im.html'
					});
				});
			});
		</script>
	</body>

</html>